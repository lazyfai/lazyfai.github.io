---
layout: post
title: KVM virtualization fix on Gentoo 2008.0 stable version
date: '2008-11-23T17:14:00.002+08:00'
author: Fai Wong
tags:
- linux
modified_time: '2008-11-23T17:20:55.097+08:00'
blogger_id: tag:blogger.com,1999:blog-8503500.post-5777912070808109153
blogger_orig_url: http://lazyfai.blogspot.com/2008/11/kvm-virtualization-fix-on-gentoo-20080.html
---

A recent kvm / kernel update breaks kvm virtualization on my gentoo 2008.0 stable version machine.<br />The situation is similar to this guy:<br />http://www.mail-archive.com/kvm@vger.kernel.org/msg06167.html<br />There is a bug in 2.6.25 kernel about HLT instruction which doesn't work well under newer kvm code, which is fixed in 2.6.26.1, but gentoo's kernel is just too old for that, after a week of search, I found the solution is just a line of code change.<br />--- a/arch/x86/kvm/x86_emulate.c<br />+++ b/arch/x86/kvm/x86_emulate.c<br />@@ -1666,7 +1666,7 @@ special_insn:<br />                break;<br />        case 0xf4:              /* hlt */<br />                ctxt->vcpu->arch.halt_request = 1;<br />-               goto done;<br />+               break;<br />        case 0xf5:      /* cmc */<br />                /* complement carry flag from eflags reg */<br />                ctxt->eflags ^= EFLG_CF;