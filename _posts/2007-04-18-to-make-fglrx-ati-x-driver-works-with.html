---
layout: post
title: To make fglrx (ATI X driver) works with xen kernel
date: '2007-04-18T10:27:00.000+08:00'
author: Fai Wong
tags:
- linux
modified_time: '2007-04-18T10:28:48.717+08:00'
blogger_id: tag:blogger.com,1999:blog-8503500.post-4813815745222504771
blogger_orig_url: http://lazyfai.blogspot.com/2007/04/to-make-fglrx-ati-x-driver-works-with.html
---

From http://pastebin.ca/350588<br />Tested and it really works, even with latest ATI driver.<br /><br />iwan ~ # cat /usr/local/portage/x11-drivers/ati-drivers-xen/files/fglrx-r3.patch<br />diff -Nur old/common/lib/modules/fglrx/build_mod/agpgart_be.c new/common/lib/modules/fglrx/build_mod/agpgart_be.c<br />--- old/common/lib/modules/fglrx/build_mod/agpgart_be.c 2007-01-09 12:26:33.000000000 +0100<br />+++ new/common/lib/modules/fglrx/build_mod/agpgart_be.c 2007-02-11 15:25:38.694160228 +0100<br />@@ -128,10 +128,17 @@<br /> #include <linux/pm_legacy.h><br /> #endif<br /> #endif<br />-#include <asm/system.h><br /> #include <asm/uaccess.h><br />+<br />+#if defined(CONFIG_X86_XEN) &&amp; (LINUX_VERSION_CODE > KERNEL_VERSION(2,6,9))<br />+#include <asm/mach-xen/asm/system.h><br />+#include <asm/mach-xen/asm/io.h><br />+#include <asm/mach-xen/asm/page.h><br />+#else<br />+#include <asm/system.h><br /> #include <asm/io.h><br /> #include <asm/page.h><br />+#endif<br /><br /> #include "agp_backend.h"<br /> #include "agp.h"<br />@@ -1188,7 +1195,11 @@<br />     if (!err)<br /> #endif<br />     {<br />+#if defined(CONFIG_X86_XEN) &&amp; ( LINUX_VERSION_CODE > KERNEL_VERSION(2,6,9))<br />+       agp_bridge.gatt_table = ioremap_nocache(virt_to_bus(table),<br />+#else<br />        agp_bridge.gatt_table = ioremap_nocache(virt_to_phys(table),<br />+#endif<br />                                        (PAGE_SIZE * (1 << page_order)));<br />     }<br />        CACHE_FLUSH();<br />@@ -3225,8 +3236,12 @@<br />     if (!err)<br /> #endif<br />     {<br />-        page_map->remapped = ioremap_nocache(virt_to_phys(page_map->real),<br />-            PAGE_SIZE);<br />+#if defined(CONFIG_X86_XEN) &&amp; (LINUX_VERSION_CODE > KERNEL_VERSION(2,6,9))<br />+       page_map->remapped = ioremap_nocache(virt_to_bus(page_map->real),<br />+#else<br />+       page_map->remapped = ioremap_nocache(virt_to_phys(page_map->real),<br />+#endif<br />+       PAGE_SIZE);<br />     }<br /><br />     if ( (page_map->remapped == NULL)<br />@@ -4698,7 +4713,11 @@<br />     if (!err)<br /> #endif<br />     {<br />+#if defined(CONFIG_X86_XEN) &&amp; ( LINUX_VERSION_CODE > KERNEL_VERSION(2,6,9))<br />+       page_map->remapped = ioremap_nocache(virt_to_bus(page_map->real),<br />+#else<br />        page_map->remapped = ioremap_nocache(virt_to_phys(page_map->real),<br />+#endif<br />                                            PAGE_SIZE);<br />     }<br /><br />@@ -5795,7 +5814,11 @@<br />         err = change_page_attr(virt_to_page(page_map->real), 1, PAGE_KERNEL_NOCACHE);<br /> #endif<br />         CACHE_FLUSH();<br />+#if defined(CONFIG_X86_XEN) &&amp; (LINUX_VERSION_CODE > KERNEL_VERSION(2,6,9))<br />+       page_map->remapped = ioremap_nocache(virt_to_bus(page_map->real),<br />+#else<br />         page_map->remapped = ioremap_nocache(virt_to_phys(page_map->real),<br />+#endif<br />                                             PAGE_SIZE);<br />         if (page_map->remapped == NULL || err) {<br />                 ClearPageReserved(virt_to_page(page_map->real));<br />diff -Nur old/common/lib/modules/fglrx/build_mod/drmP.h new/common/lib/modules/fglrx/build_mod/drmP.h<br />--- old/common/lib/modules/fglrx/build_mod/drmP.h       2007-01-09 12:26:33.000000000 +0100<br />+++ new/common/lib/modules/fglrx/build_mod/drmP.h       2007-02-11 15:21:56.025129785 +0100<br />@@ -59,7 +59,13 @@<br /> #if defined(__alpha__) || defined(__powerpc__)<br /> #include <asm/pgtable.h> /* For pte_wrprotect */<br /> #endif<br />+<br />+#if defined(CONFIG_X86_XEN) &&amp; (LINUX_VERSION_CODE > KERNEL_VERSION(2,6,9))<br />+#include <asm/mach-xen/asm/io.h><br />+#else<br /> #include <asm/io.h><br />+#endif<br />+<br /> #include <asm/mman.h><br /> #include <asm/uaccess.h><br /> #ifdef CONFIG_MTRR<br />@@ -80,7 +86,13 @@<br /> #include <linux/workqueue.h><br /> #endif<br /> #include <linux/poll.h><br />+<br />+#if defined(CONFIG_X86_XEN) &&amp; (LINUX_VERSION_CODE > KERNEL_VERSION(2,6,9))<br />+#include <asm/mach-xen/asm/pgalloc.h><br />+#else<br /> #include <asm/pgalloc.h><br />+#endif<br />+<br /> #include "drm.h"<br /><br /> #include "drm_os_linux.h"<br />diff -Nur old/common/lib/modules/fglrx/build_mod/firegl_public.c new/common/lib/modules/fglrx/build_mod/firegl_public.c<br />--- old/common/lib/modules/fglrx/build_mod/firegl_public.c      2007-02-11 00:47:36.000000000 +0100<br />+++ new/common/lib/modules/fglrx/build_mod/firegl_public.c      2007-02-11 15:17:24.457559120 +0100<br />@@ -43,6 +43,7 @@<br /> #if !defined(CONFIG_X86_BIGSMP)<br /> #if !defined(CONFIG_X86_VISWS)<br /> #if !defined(CONFIG_X86_GENERICARCH)<br />+#if !defined(CONFIG_X86_XEN)<br /> #error unknown or undefined architecture configured<br /> #endif<br /> #endif<br />@@ -52,6 +53,7 @@<br /> #endif<br /> #endif<br /> #endif<br />+#endif<br /> #endif /* LINUX_VERSION_CODE */<br /><br /> /* The dirty-page-tracking patch included in NLD 9 SMP kernels defines<br />@@ -122,12 +124,29 @@<br /> #include <linux/console.h><br /><br /> //#include <linux/signal.h><br />+#if defined(CONFIG_X86_XEN) &&amp; (LINUX_VERSION_CODE > KERNEL_VERSION(2,6,9))<br />+#include <asm/mach-xen/asm/io.h><br />+#else<br /> #include <asm/io.h><br />+#endif<br />+<br /> #include <asm/mman.h><br /> #include <asm/uaccess.h><br />+<br />+#if defined(CONFIG_X86_XEN) &&amp; (LINUX_VERSION_CODE > KERNEL_VERSION(2,6,9))<br />+#include <asm/mach-xen/asm/processor.h><br />+#else<br /> #include <asm/processor.h><br />+#endif<br />+<br /> #if LINUX_VERSION_CODE >= KERNEL_VERSION(2,6,0)<br />+<br />+#if defined(CONFIG_X86_XEN) &&amp; (LINUX_VERSION_CODE > KERNEL_VERSION(2,6,9))<br />+#include <asm/mach-xen/asm/tlbflush.h><br />+#else<br /> #include <asm/tlbflush.h> // for flush_tlb_page<br />+#endif<br />+<br /> #else<br /> #include <asm/pgalloc.h> // for flush_tlb_page<br /> #endif<br />@@ -167,6 +186,10 @@<br /><br /> #include <linux/kmod.h><br /> #include "firegl_public.h"<br />+<br />+#if defined(CONFIG_X86_XEN) &&amp; (LINUX_VERSION_CODE > KERNEL_VERSION(2,6,9))<br />+#include <asm/mach-xen/asm/pgtable.h><br />+#endif<br /> // ============================================================<br /> #ifndef TRUE<br /> #define TRUE 1<br />diff -Nur old/common/lib/modules/fglrx/build_mod/firegl_public.h new/common/lib/modules/fglrx/build_mod/firegl_public.h<br />--- old/common/lib/modules/fglrx/build_mod/firegl_public.h      2007-01-09 12:26:33.000000000 +0100<br />+++ new/common/lib/modules/fglrx/build_mod/firegl_public.h      2007-02-11 14:26:55.808598509 +0100<br />@@ -36,8 +36,14 @@<br /><br /> #if LINUX_VERSION_CODE > KERNEL_VERSION(2,6,9)<br /><br />+#if defined(CONFIG_X86_XEN)<br />+#define REMAP_PAGE_RANGE_FN io_remap_pfn_range<br />+#define REMAP_PAGE_RANGE_STR "io_remap_pfn_range"<br />+#else<br /> #define REMAP_PAGE_RANGE_FN remap_pfn_range<br /> #define REMAP_PAGE_RANGE_STR "remap_pfn_range"<br />+#endif /* CONFIG_X86_XEN */<br />+<br /> #define REMAP_PAGE_RANGE_OFF(offset) ((offset) >> PAGE_SHIFT)<br /><br /> #else /* LINUX_VERSION_CODE <= KERNEL_VERSION(2,6,9) */<br />@@ -48,13 +54,24 @@<br /><br /> #endif /* LINUX_VERSION_CODE > KERNEL_VERSION(2,6,9) */<br /><br />+#if defined(CONFIG_X86_XEN) &&amp; (LINUX_VERSION_CODE > KERNEL_VERSION(2,6,9))<br />+<br /> #define REMAP_PAGE_RANGE(vma,offset) \<br />-    REMAP_PAGE_RANGE_FN(FGL_VMA_API_PASS \<br />+    REMAP_PAGE_RANGE_FN(vma, \<br />                         (vma)->vm_start,       \<br />                         REMAP_PAGE_RANGE_OFF(offset), \<br />                         (vma)->vm_end - (vma)->vm_start, \<br />                         (vma)->vm_page_prot)<br /><br />+#else<br />+<br />+#define REMAP_PAGE_RANGE(vma,offset) \<br />+    REMAP_PAGE_RANGE_FN(FGL_VMA_API_PASS \<br />+                        (vma)->vm_start,       \<br />+                        REMAP_PAGE_RANGE_OFF(offset), \<br />+                        (vma)->vm_end - (vma)->vm_start, \<br />+                        (vma)->vm_page_prot)<br />+#endif<br /><br /> /* Page table macros */